{"componentChunkName":"component---src-templates-blog-post-js","path":"/azure-web-job-on-docker/","result":{"data":{"site":{"siteMetadata":{"title":"simplified.io"}},"markdownRemark":{"id":"61df27d3-6e7e-5a01-8fb8-8910aae94580","excerpt":"What is WebJobs SDK? The Azure WebJobs SDK is a framework that simplifies the task of writing background processing code that runs in Azure WebJobs. It includes…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/KoditkarVedant.github.io/static/90eec5339e9d09d221a320590c211d77/c1b63/docker_dotnet.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.78378378378378%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAAA9UlEQVQoz2NQNrJUMTTHgowslA3MlPVNlA3NlbEqMDRnAEkYmGJBOoaqpjZqjp4quoYqukZY1eDQrG+s7OilWtajkVOn6hOpHF8CMsLQjAjNQEW6Bmol/ZpLz0vMPCpXt0DNwRNoHFE2qxqaKeoYmrl4OZc0i0cXK1s6qWjrqxiYEetsoH4FbQMNHX1jEzNlbA7G62cw0jG1MLKwVNYzxmotXs36RoqmjjL24crGVlg9jEuzmYqekZKFq0hEt0h4p4xrImmaVfUMFGz8+ZMXSfkWigfXkaQZhIDJS9Y1Qcq/RME2AOgFEkIb7GcTsB4ToCtwhSgAn0iK+JExEmMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Chinese Salty Egg\"\n        title=\"Chinese Salty Egg\"\n        src=\"/KoditkarVedant.github.io/static/90eec5339e9d09d221a320590c211d77/fcda8/docker_dotnet.png\"\n        srcset=\"/KoditkarVedant.github.io/static/90eec5339e9d09d221a320590c211d77/12f09/docker_dotnet.png 148w,\n/KoditkarVedant.github.io/static/90eec5339e9d09d221a320590c211d77/e4a3f/docker_dotnet.png 295w,\n/KoditkarVedant.github.io/static/90eec5339e9d09d221a320590c211d77/fcda8/docker_dotnet.png 590w,\n/KoditkarVedant.github.io/static/90eec5339e9d09d221a320590c211d77/efc66/docker_dotnet.png 885w,\n/KoditkarVedant.github.io/static/90eec5339e9d09d221a320590c211d77/c83ae/docker_dotnet.png 1180w,\n/KoditkarVedant.github.io/static/90eec5339e9d09d221a320590c211d77/c1b63/docker_dotnet.png 1200w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h3>What is WebJobs SDK?</h3>\n<p>The Azure WebJobs SDK is a framework that simplifies the task of writing background processing code that runs in Azure WebJobs. It includes a declarative binding and trigger system that works with Azure Storage Blobs, Queues and Tables as well as Service Bus. The binding system makes it incredibly easy to write code that reads or writes Azure Storage objects. The trigger system automatically invokes a function in your code whenever any new data is received in a queue or blob.</p>\n<p>The version 3.x of the WebJobs SDK supports both .NET Core and .NET Framework console apps. This opens all sorts of possibilities of hosting it apart from App Service. In this article I’ll walk you through process of hosting the Web Job on Docker.</p>\n<h3>Create Web job using Web Job SDK 3</h3>\n<p>Let’s create simple queue triggered web job which will print the message received in the azure queue.</p>\n<ol>\n<li>open a command prompt and enter the below command.</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet new console -o <span class=\"token string\">\"ContainerizedWebJob\"</span>\n<span class=\"token builtin class-name\">cd</span> ContainerizedWebJob</code></pre></div>\n<ol start=\"2\">\n<li>\n<p>Install the latest stable 3.x versions of the following NuGet packages.</p>\n<ul>\n<li>Microsoft.Azure.WebJobs</li>\n<li>Microsoft.Azure.WebJobs.Extensions</li>\n</ul>\n</li>\n</ol>\n<p>Here are the commands:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet <span class=\"token function\">add</span> package Microsoft.Azure.WebJobs --version <span class=\"token number\">3.0</span>.11\ndotnet <span class=\"token function\">add</span> package Microsoft.Azure.WebJobs.Extensions --version <span class=\"token number\">3.0</span>.2</code></pre></div>\n<ol start=\"3\">\n<li>We will need console logging using which we will print the recieved message from the queue on the console. Install the latest version of belo packages</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet <span class=\"token function\">add</span> package Microsoft.Extensions.Logging --version <span class=\"token number\">2.2</span>.0\ndotnet <span class=\"token function\">add</span> package Microsoft.Extensions.Logging.Console --version <span class=\"token number\">2.2</span>.0</code></pre></div>\n<ol start=\"4\">\n<li>Install storage binding extension Starting with version 3.x, you must explicitly install the Storage binding extension required by the WebJobs SDK. In prior versions, the Storage bindings were included in the SDK. Install latest version of below package</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet <span class=\"token function\">add</span> package Microsoft.Azure.WebJobs.Extensions.Storage --version <span class=\"token number\">3.0</span>.7</code></pre></div>\n<ol start=\"5\">\n<li>Now we will create the host and configure it.Add program.cs file and replace the content of with below.</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">Microsoft<span class=\"token punctuation\">.</span>Extensions<span class=\"token punctuation\">.</span>Hosting</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">Microsoft<span class=\"token punctuation\">.</span>Extensions<span class=\"token punctuation\">.</span>Logging</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token namespace\">ContainerizedWebJob</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">class</span> <span class=\"token class-name\">Program</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span> args<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> builder <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">HostBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            builder<span class=\"token punctuation\">.</span><span class=\"token function\">UseEnvironment</span><span class=\"token punctuation\">(</span>EnvironmentName<span class=\"token punctuation\">.</span>Development<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            builder<span class=\"token punctuation\">.</span><span class=\"token function\">ConfigureWebJobs</span><span class=\"token punctuation\">(</span>b <span class=\"token operator\">=></span>\n            <span class=\"token punctuation\">{</span>\n                b<span class=\"token punctuation\">.</span><span class=\"token function\">AddAzureStorageCoreServices</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                b<span class=\"token punctuation\">.</span><span class=\"token function\">AddAzureStorage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            builder<span class=\"token punctuation\">.</span><span class=\"token function\">ConfigureLogging</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n            <span class=\"token punctuation\">{</span>\n                b<span class=\"token punctuation\">.</span><span class=\"token function\">AddConsole</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> host <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">Build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">using</span> <span class=\"token punctuation\">(</span>host<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                host<span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Add <code class=\"language-text\">Functions.cs</code> file which will have the functions which will process the queue message.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">Microsoft<span class=\"token punctuation\">.</span>Azure<span class=\"token punctuation\">.</span>WebJobs</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">Microsoft<span class=\"token punctuation\">.</span>Extensions<span class=\"token punctuation\">.</span>Logging</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">namespace</span> <span class=\"token namespace\">ContainerizedWebJob</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Functions</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">ProcessQueueMessage</span><span class=\"token punctuation\">(</span>\n            <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">QueueTrigger</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"message-queue\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> message<span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">ILogger</span> logger<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            logger<span class=\"token punctuation\">.</span><span class=\"token function\">LogInformation</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Add appsettings.json</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"AzureWebJobsStorage\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"UseDevelopmentStorage=true\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ol start=\"6\">\n<li>Modify <code class=\"language-text\">ContainerizedWebJob.csproj</code> and add new <code class=\"language-text\">&lt;ItemGroup&gt;</code>.</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ItemGroup</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>None</span> <span class=\"token attr-name\">Update</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>appsettings.json<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>CopyToOutputDirectory</span><span class=\"token punctuation\">></span></span>Always<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>CopyToOutputDirectory</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>None</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ItemGroup</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<ol start=\"7\">\n<li>Lets run an test it.</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet build\ndotnet run</code></pre></div>\n<p>Create a queue named <code class=\"language-text\">message-queue</code> add the message.</p>\n<h3>Deploy Web job on docker.</h3>\n<p>To deploy this application on docker we need to specify docker configuration. Add <code class=\"language-text\">Dockerfile</code> at the root of the application.</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token keyword\">FROM</span> mcr.microsoft.com/dotnet/core/runtime<span class=\"token punctuation\">:</span>2.2\n<span class=\"token keyword\">WORKDIR</span> /app\n<span class=\"token keyword\">COPY</span> ./bin/Debug/netcoreapp2.2/publish .\n<span class=\"token keyword\">ENTRYPOINT</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"dotnet\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ContainerizedWebJob.dll\"</span> <span class=\"token punctuation\">]</span></code></pre></div>\n<p>Before we deploy this app on docker we need to make changes to our <code class=\"language-text\">appsettings.json</code> file as below.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"AzureWebJobsStorage\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"UseDevelopmentStorage=true;DevelopmentStorageProxyUri=http://host.docker.internal\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>Note:</strong> The <strong>Azure Storage Emulator</strong> is bound in a local-only network configuration and <strong>Docker</strong> for Windows runs in a <strong>VM</strong> using <strong>Hyper-V</strong>. Hence to access the emulator running on host (Windows) we need to use the proxy <code class=\"language-text\">http://host.docker.internal</code> instead of <code class=\"language-text\">http://127.0.0.1</code>.</p>\n<p>Now that we are done with all the configuration we shall create and run the docker image. To create a docker image, run the below command where you have put the <code class=\"language-text\">Dockerfile</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">docker build -t containerized-web-job</code></pre></div>\n<p>Once the image is create we shall run it using below command.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">docker run -it --rm containerized-web-job</code></pre></div>\n<p><strong>Note:</strong> above command will delete the container as soon as we stop the web job.</p>\n<p>You can find source code <a href=\"https://github.com/KoditkarVedant/containerized-web-job\" target=\"_blank\">here</a>.</p>","frontmatter":{"title":"Deploy Azure web job on Docker","date":"August 16, 2019","description":"deploy azure web job on docker 🐳🐳🐳"}}},"pageContext":{"slug":"/azure-web-job-on-docker/","previous":null,"next":null}}}